<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.3">
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="stylesheet" href="http://54.84.229.93/css/styles-452af12eaa.css"/>
        <script src="http://54.84.229.93/js/bundle-bcaaf59313.js"></script>
        <title>Caching Query Results &middot; Apache Cayenne</title>
    </head>
    <body data-spy="scroll" data-target=".toc-side" class="cd-head"> 
<header class="page-header">
    <nav id="topbar" class="bg-dark" aria-label="breadcrumb" role="navigation">
      <ul class="breadcrumb breadcrumb-sm breadcrumb-dark  container  mb-0">
        <img class="mh-26px  mr-1" src="/img/feather-641aa69d09.svg" />
        <li class="breadcrumb-item dropdown">
          <a class="dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Apache Software Foundation</a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="http://www.apache.org">Apache Homepage</a>
            <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a>
            <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
            <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a>
            <a class="dropdown-item" href="http://www.apache.org/security/">Security</a>
          </div>
        </li>
        <li class="breadcrumb-item d-none d-lg-inline-block">Apache Cayenne</li>
      </ul>
    </nav>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="http://54.84.229.93/">
           <img src="/img/logo_mono_full-d7a19eef61.svg" alt="Apache Cayenne" />
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#mainMenu" aria-controls="mainMenu" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainMenu">
          <ul class="navbar-nav  mt-3 mt-lg-0 mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="/download/">DOWNLOAD</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="/docs/">DOCUMENTATION</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="/about/support/">SUPPORT</a>
            </li>
            
          </ul>
          <ul class="navbar-nav  flex-row justify-content-center  mt-2 mt-lg-0 mb-2 mb-lg-0 " id="social-links-menu">
            <li class="nav-item  d-flex">
              <a class="nav-link  d-flex justify-content-center align-items-center" href="https://github.com/apache/cayenne">
                <img src="/img/icon_octocat_stars-c24dac94b8.svg" alt="GitHub" /><span class="stargazers_count  ml-1l2"></span></a>
            </li>
            <li class="nav-item  d-flex">
              <a class="nav-link  d-flex justify-content-center align-items-center" href="https://twitter.com/ApacheCayenne">
                <img src="/img/icon_twitter-220a129d14.svg" alt="Twitter" />
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
</header>








<main>
    <div class="cd-top-sidebar  bb">
        <div class="container">
            <div class="row no-gutters">
                
                <div class="col-12 col-lg-4 col-xl-3  br  cd-sidebar1">
                    <ul class="nav" role="tablist">
                        <li class="nav-item dropdown mw-100">
                            <a class="nav-link dropdown-toggle text-truncate" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                                Cayenne Version 2.0
                            </a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="/docs/4.1/cayenne-guide/">Version 4.1 (Alpha)</a><a class="dropdown-item" href="/docs/4.0/cayenne-guide/">Version 4.0 (Beta)</a><a class="dropdown-item" href="/docs/3.1/getting-started-guide/">Version 3.1 (Stable)</a><a class="dropdown-item" href="/docs/3.0/cayenne-guide.html">Version 3.0 (Legacy)</a><a class="dropdown-item" href="/docs/2.0/user-guide.html">Version 2.0 (Legacy)</a><a class="dropdown-item" href="/docs/1.2/user-guide.html">Version 1.2 (Legacy)</a>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="col-12 col-lg-8 col-xl-9">  </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row no-gutters  ">
            <div class="col-12 col-lg-4 col-xl-3  br  py-2  bg-gray-100  cd-sidebar">
                <div class="tab-content" id="cd-docs-nav">
                    
                    <div class="cd-toc-item">
                        
                            <a class="cd-toc-link" href="/docs/2.0/user-guide.html">User Guide</a>
                        
                    </div>
                    
                    <div class="cd-toc-item">
                        
                            <a class="cd-toc-link" href="/docs/2.0/modeler-guide.html">Modeler Guide</a>
                        
                    </div>
                    
                    <div class="cd-toc-item">
                        
                            <a class="cd-toc-link" href="/docs/2.0/remote-object-persistence-guide.html">Remote Object Persistence Guide</a>
                        
                    </div>
                    
                    <div class="cd-toc-item">
                        <a class="cd-toc-link" href="/docs/2.0/api/">JavaDoc</a>
                    </div>
                </div>
            </div>
            
            <div class="col-12 col-lg-8 col-xl-9  py-3 pl-lg-5  cd-content">

            
            <article>
                <section>
                    <P>Cayenne provides a way to cache query results, avoiding unneeded database trips for the frequently used queries. Caching policy is configured per query. Policy can be set via the API or in CayenneModeler.</P>

<DIV class="panelMacro"><TABLE class="noteMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><img src="/docs/2.0/images/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD><B>Upgrading to Cayenne 1.2 and Newer</B><BR><TT>org.apache.cayenne.query.GenericSelectQuery</TT> interface that defined cache policy types is deprecated. Cache policies are now a part of the new <TT>org.apache.cayenne.query.QueryMetadata</TT> interface.</TD></TR></TABLE></DIV>

<P>The following cache policies are supported:</P>

<DIV class="table-wrap">
<TABLE class="confluenceTable"><TBODY>
<TR>
<TH class="confluenceTh">Policy</TH>
<TH class="confluenceTh">Cache Scope</TH>
<TH class="confluenceTh">Cache Behavior</TH>
</TR>
<TR>
<TD class="confluenceTd"><EM>(default policy)</EM> <TT>QueryMetadata.NO_CACHE</TT> </TD>
<TD class="confluenceTd">N/A</TD>
<TD class="confluenceTd">Always fetch, never use cache, never save to cache</TD>
</TR>
<TR>
<TD class="confluenceTd"><TT>QueryMetadata.LOCAL_CACHE</TT></TD>
<TD class="confluenceTd">DataContext</TD>
<TD class="confluenceTd">If result is previously cached, use it, otherwise do a fetch and store result in cache for future use</TD>
</TR>
<TR>
<TD class="confluenceTd"><TT>QueryMetadata.LOCAL_CACHE_REFRESH</TT></TD>
<TD class="confluenceTd">DataContext</TD>
<TD class="confluenceTd">Never use cache, alwyas do a fetch and store result in cache for future use</TD>
</TR>
<TR>
<TD class="confluenceTd"><TT>QueryMetadata.SHARED_CACHE</TT></TD>
<TD class="confluenceTd">DataDomain (usually shared by all contexts in the same JVM)</TD>
<TD class="confluenceTd">If result is previously cached, use it, otherwise do a fetch and store result in cache for future use</TD>
</TR>
<TR>
<TD class="confluenceTd"><TT>QueryMetadata.SHARED_CACHE_REFRESH</TT></TD>
<TD class="confluenceTd">DataDomain (usually shared by all contexts in the same JVM)</TD>
<TD class="confluenceTd">Never use cache, alwyas do a fetch and store result in cache for future use</TD>
</TR>
</TBODY></TABLE>
</DIV>


<P>It is important to understand that caching of <B>result lists</B> is done independently from caching of <B>individual DataObjects and DataRows</B>. Therefore the API is different as well. Also cached results lists are not synchronized across VMs (even the shared cache).</P>


<H3><A name="CachingQueryResults-APIforResultCaching"></A>API for Result Caching</H3>

<P>Users must set two Query parameters to configure caching - query <B>name</B> that is used as a key to result cache and query <B>cache policy</B> (one of the policies above). Note that if two unrelated queries have the same name, they will hit the same cache entry. This is not a bug, this is a feature that should be taken into consideration when naming queries.</P>

<P>Below we will create a query and set its caching policy to LOCAL_CACHE:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">SelectQuery query = <SPAN class="code-keyword">new</SPAN> SelectQuery(Artist.class);

<SPAN class="code-comment">// set query name that will be used as a unique key to perform result caching
</SPAN>query.setName(<SPAN class="code-quote">&quot;MySelect&quot;</SPAN>);

<SPAN class="code-comment">// set local cache policy, meaning the cache will be stored in the DataContext 
</SPAN><SPAN class="code-comment">// and not shared between different contexts
</SPAN>query.setCachePolicy(GenericSelectQuery.LOCAL_CACHE);

DataContext context = ... <SPAN class="code-comment">// assume <SPAN class="code-keyword">this</SPAN> exists
</SPAN>
<SPAN class="code-comment">// there is probably no cache at <SPAN class="code-keyword">this</SPAN> point, so the query will hit the database
</SPAN>List objects = context.performQuery(query);
</PRE>
</DIV></DIV>

<P>Reruning the query in the same DataContext at a later time will be much faster as it will be hitting the cache:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">List objects1 = context.performQuery(query);
</PRE>
</DIV></DIV>

<P>Here we want to refresh the cache, but still keep caching the fresh result:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">query.setCachePolicy(GenericSelectQuery.LOCAL_CACHE_REFRESH);

List objects2 = context.performQuery(query);
</PRE>
</DIV></DIV>

<P>The example above shows caching with <TT>SelectQuery</TT>, but it works exactly the same way for <TT>SQLTemplate</TT> and <TT>ProcedureQuery</TT>. Similarly <TT>SHARED_CACHE</TT> and <TT>SHARED_CACHE_REFRESH</TT> cache policies create cache shared by all DataDontexts that work with a given DataDomain. </P>


<DIV class="panelMacro"><TABLE class="noteMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><img src="/docs/2.0/images/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD><B>Upgrading to Cayenne 1.2 and Newer</B><BR>Cache refreshing API has changed in 1.2. Cayenne 1.1 relied on the use of <TT>SelectQuery.setRefreshingObjects(..)</TT> to determine whether to expire cached result lists. This is no longer the case (setting this flag only refreshes <B>individual objects</B> as it should, and has no effect whatsoever on list caching). Instead caching and cache refreshing is controlled by the cache policy as described above.</TD></TR></TABLE></DIV>


<H3><A name="CachingQueryResults-QueriesMappedinCayenneModeler"></A>Queries Mapped in CayenneModeler</H3>

<P>The easiest way to set up caching is by creating a named query in CayenneModeler with the appropriate caching type.</P>

<P><SPAN class="image-wrap" style=""><img src="/docs/2.0/images/caching.jpg" style="border: 0px solid black"></SPAN></P>

<P>Then it can be executed via DataContext:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">List objects1 = context.performQuery(<SPAN class="code-quote">&quot;MyQuery&quot;</SPAN>, <SPAN class="code-keyword">false</SPAN>);
</PRE>
</DIV></DIV>

<P>The second &quot;false&quot; parameter above indicated that if possible, cached result should be used. Now if we want to force refresh, it can be changed to true (for just this invocation - this does not affect the underlying saved query)</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">List objects2 = context.performQuery(<SPAN class="code-quote">&quot;MyQuery&quot;</SPAN>, <SPAN class="code-keyword">true</SPAN>);
</PRE>
</DIV></DIV>

<P>Note that parameterized named queries will still work correctly with the cache. We've already mentioned that the users must ensure that two queries must have different names if they fetch logically different data. This is NOT the case with queries stored in the DataMap. If you run the same named query with different sets of parameters, Cayenne will internally generate unique cache keys for each distinct parameter set.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">Map parameters = Collections.singletonMap(<SPAN class="code-quote">&quot;key&quot;</SPAN>, <SPAN class="code-quote">&quot;value1&quot;</SPAN>);
List objects1 = context.performQuery(<SPAN class="code-quote">&quot;MyQuery&quot;</SPAN>, parameters, <SPAN class="code-keyword">false</SPAN>);
</PRE>
</DIV></DIV>

<P>Now if we run the same query with a different set of parameters, Cayenne will do the right thing and create a separate entry in the cache:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">Map parameters = Collections.singletonMap(<SPAN class="code-quote">&quot;key&quot;</SPAN>, <SPAN class="code-quote">&quot;value2&quot;</SPAN>);
List objects2 = context.performQuery(<SPAN class="code-quote">&quot;MyQuery&quot;</SPAN>, parameters, <SPAN class="code-keyword">false</SPAN>);
</PRE>
</DIV></DIV>



                </section>
            </article>

	        </div>
	    </div>
	</div>
</main>

<footer class="bg-dark">
    <div class="footer-nav container  text-center text-lg-left  pb-3">
        <div class="row  pt-5 pb-3">
            
            <div class="col-sm-6 col-lg-3">
                <h4>About</h4>
                <ul class="list-unstyled">
                    
                    <li>
                        <a href="/why-cayenne.html">Why Cayenne?</a>
                    </li>
                    
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    
                    <li>
                        <a href="/success-stories.html">Success Stories</a>
                    </li>
                    
                    <li>
                        <a href="/about/support/">Support</a>
                    </li>
                    
                </ul>
            </div>
            
            <div class="col-sm-6 col-lg-3">
                <h4>Documentation</h4>
                <ul class="list-unstyled">
                    
                    <li>
                        <a href="/docs/4.0/getting-started-guide/">Getting Started (4.0)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.1/getting-started-guide/">Getting Started (4.1)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.0/cayenne-guide/">Cayenne Guide (4.0)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.1/cayenne-guide/">Cayenne Guide (4.1)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.1/getting-started-db-first/">Database First tutorial (4.1)</a>
                    </li>
                    
                </ul>
            </div>
            
            <div class="col-sm-6 col-lg-3">
                <h4>Collaboration</h4>
                <ul class="list-unstyled">
                    
                    <li>
                        <a href="https://issues.apache.org/jira/browse/CAY">Bug/Feature Tracker</a>
                    </li>
                    
                    <li>
                        <a href="/mailing-lists.html">Mailing Lists</a>
                    </li>
                    
                    <li>
                        <a href="/dev/code-repository.html">Code Repository</a>
                    </li>
                    
                    <li>
                        <a href="/dev/">Developer Guide</a>
                    </li>
                    
                    <li>
                        <a href="/how-can-i-help.html">How can I help?</a>
                    </li>
                    
                    <li>
                        <a href="/contributors.html">Contributors</a>
                    </li>
                    
                </ul>
            </div>
            
            <div class="col-sm-6 col-lg-3">
                <h4>News</h4>
                <ul class="list-multiline-items list-unstyled  mb-0">
                    
                    <li>
                        <time datetime="2017-11-20 12:00:00 &#43;0300 &#43;03" class="xsmall d-block">Nov 20, 2017</time>
                        <a href="/2017/11/cayenne-312-released.html">Cayenne 3.1.2 Released</a>
                    </li>
                    
                    <li>
                        <time datetime="2017-10-14 12:00:00 &#43;0300 &#43;03" class="xsmall d-block">Oct 14, 2017</time>
                        <a href="/2017/10/cayenne-41m1-released.html">Cayenne 4.1 Milestone 1 Released</a>
                    </li>
                    
                    <li>
                        <time datetime="2017-10-06 17:38:42 &#43;0300 &#43;03" class="xsmall d-block">Oct 06, 2017</time>
                        <a href="/2017/10/cayenne-40B2-released.html">Cayenne 4.0 Beta 2 Released</a>
                    </li>
                    
                </ul>
                <a class="btn-link text-uppercase xsmall" href="http://54.84.229.93/news">
                    More news
                    <i class="fa fa-lg fa-long-arrow-right" aria-hidden="true"></i>
                </a>
            </div>
        </div>
        <hr class="mt-0 mb-3" />
        <p class="copy xsmall text-center  mw-75 mx-auto mb-0">
            Copyright Â© 2001-2018 Apache Software Foundation. Apache Cayenne, Cayenne, Apache, the Apache feather logo, and the Apache Cayenne project logo are trademarks of The Apache Software Foundation. <a href="http://54.84.229.93/privacy-policy.html">Privacy policy</a>.
            <img class="d-block  mx-auto mt-2" src="/img/logo_mono-3302daa3cf.svg" alt="Apache Cayenne" />
        </p>
    </div>
</footer>
    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-7036673-1', 'auto');
ga('send', 'pageview');
</script>

    </body>
</html>
