<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.3">
        <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon-04cb17e028.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32-12431ee8eb.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16-4f316e4d55.png">
        <link rel="manifest" href="/img/favicon/manifest-65e6aaa49e.json">
        <link rel="mask-icon" href="/img/favicon/safari-pinned-tab-558c1991b1.svg" color="#dc5656">
        <link rel="shortcut icon" href="/img/favicon/favicon-6cef91375b.ico">
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="/img/favicon/mstile-144x144-34e7696278.png">
        <meta name="msapplication-config" content="/img/favicon/browserconfig-82ff158058.xml">
        <meta name="theme-color" content="#ffffff">
        <link rel="stylesheet" href="https://cayenne.apache.org/css/styles-a216e88c4f.css"/>
        <script src="https://cayenne.apache.org/js/bundle-b017b6b604.js"></script>
        <title>Prefetching &middot; Apache Cayenne</title>
    </head>
    <body data-spy="scroll" data-target=".toc-side" class="cd-head"> 
<header class="page-header">
    <nav id="topbar" class="bg-dark" aria-label="breadcrumb" role="navigation">
      <ul class="breadcrumb breadcrumb-sm breadcrumb-dark  container  mb-0">
        <li class="breadcrumb-item dropdown">
          <a class="dropdown-toggle  text-nowrap  pr-1" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <img class="mw-15px  mr-1" src="/img/feather-641aa69d09.svg" />Apache Software Foundation</a>
          <div class="dropdown-menu rounded-0" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="https://www.apache.org">Apache Homepage</a>
            <a class="dropdown-item" href="https://www.apache.org/licenses/">License</a>
            <a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
            <a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a>
            <a class="dropdown-item" href="https://www.apache.org/security/">Security</a>
            <a class="dropdown-item" href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy</a>
            <a class="ml-1 mt-1 acevent" data-format="wide" data-mode="dark" data-width="120"></a>
          </div>
        </li>
      </ul>
    </nav>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="https://cayenne.apache.org/">
           <img src="/img/logo_mono_full-d7a19eef61.svg" alt="Apache Cayenne" />
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#mainMenu" aria-controls="mainMenu" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainMenu">
          <ul class="navbar-nav  mt-3 mt-lg-0 mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="/download/">DOWNLOAD</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="/docs/4.1/getting-started-guide/">DOCUMENTATION</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="/about/support/">SUPPORT</a>
            </li>
            
          </ul>
          <ul class="navbar-nav  flex-row justify-content-center  mt-2 mt-lg-0 mb-2 mb-lg-0 " id="social-links-menu">
            <li class="nav-item  d-flex">
              <a class="nav-link  d-flex justify-content-center align-items-center" href="https://github.com/apache/cayenne">
                <img src="/img/icon_octocat_stars-c24dac94b8.svg" alt="GitHub" />
              </a>
            </li>
            <li class="nav-item  d-flex">
              <a class="nav-link  d-flex justify-content-center align-items-center" href="https://twitter.com/ApacheCayenne">
                <img src="/img/icon_twitter-220a129d14.svg" alt="Twitter" />
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
</header>








<main>
    <div class="cd-top-sidebar  bb">
        <div class="container">
            <div class="row no-gutters">
                
                <div class="col-12 col-lg-4 col-xl-3  br  cd-sidebar1">
                    <ul class="nav" role="tablist">
                        <li class="nav-item dropdown mw-100">
                            <a class="nav-link dropdown-toggle text-truncate" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                                Cayenne Version 2.0
                            </a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="/docs/4.2/getting-started-guide/">Version 4.2 (Stable)</a><a class="dropdown-item" href="/docs/4.1/getting-started-guide/">Version 4.1 (Stable)</a><a class="dropdown-item" href="/docs/4.0/getting-started-guide/">Version 4.0 (Aging)</a><a class="dropdown-item" href="/docs/3.1/getting-started-guide/">Version 3.1 (Legacy)</a><a class="dropdown-item" href="/docs/3.0/cayenne-guide.html">Version 3.0 (Legacy)</a><a class="dropdown-item" href="/docs/2.0/user-guide.html">Version 2.0 (Legacy)</a><a class="dropdown-item" href="/docs/1.2/user-guide.html">Version 1.2 (Legacy)</a>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="col-12 col-lg-8 col-xl-9">  </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row no-gutters  ">
            <div class="col-12 col-lg-4 col-xl-3  br  py-2  bg-gray-100  cd-sidebar">
                <div class="tab-content" id="cd-docs-nav">
                    
                    <div class="cd-toc-item">
                        
                            <a class="cd-toc-link" href="/docs/2.0/user-guide.html">User Guide</a>
                        
                    </div>
                    
                    <div class="cd-toc-item">
                        
                            <a class="cd-toc-link" href="/docs/2.0/modeler-guide.html">Modeler Guide</a>
                        
                    </div>
                    
                    <div class="cd-toc-item">
                        
                            <a class="cd-toc-link" href="/docs/2.0/remote-object-persistence-guide.html">Remote Object Persistence Guide</a>
                        
                    </div>
                    
                    <div class="cd-toc-item">
                        <a class="cd-toc-link" href="/docs/2.0/api/">JavaDoc</a>
                    </div>
                </div>
            </div>
            
            <div class="col-12 col-lg-8 col-xl-9  py-3 pl-lg-5  cd-content">

            
            <article>
                <section>
                    
	
<H3><A name="Prefetching-IntroductiontoPrefetching"></A>Introduction to Prefetching</H3>

<P>Prefetching is a performance optimization technique that allows to bring back more than one type of objects in a single query. Prefetches are configured in terms of relationship paths from the query root entity to the &quot;prefetched&quot; entity. E.g.:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-comment">// configure query with prefetches
</SPAN>SelectQuery query = <SPAN class="code-keyword">new</SPAN> SelectQuery(Artist.class);
query.addPrefetch(<SPAN class="code-quote">&quot;paintingArray&quot;</SPAN>); 
...
<SPAN class="code-comment">// execute query and <SPAN class="code-keyword">do</SPAN> something with results
</SPAN>List artists = context.performQuery(query);
Iterator it = artists.iterator();
<SPAN class="code-keyword">while</SPAN>(it.hasNext()) {
  Artist a = (Artist) it.next();
  <SPAN class="code-object">System</SPAN>.out.println(<SPAN class="code-quote">&quot;paintings: &quot;</SPAN> + a.getPaintingArray().size());
}
</PRE>
</DIV></DIV>

<P>When prefetching is set, corresponding relationships are &quot;inflated&quot; with database objects within a single <TT>performQuery</TT> run, leaving it up to Cayenne to optimize retrieval of multiple entities. For instance the example above results in just two SQL queries issued to the database internally, while running the same query without a prefetch and later iterating over artists will result in <TT>1 + N</TT> queries, where <TT>N</TT> is the number of artists returned. </P>

<H3><A name="Prefetching-PrefetchingHints"></A>Prefetching Hints</H3>

<UL>
	<LI>All types of relationships can be prefetched - to-one, to-many, flattened.</LI>
	<LI>A prefetch can span more than one relationship:
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
query.addPrefetch(<SPAN class="code-quote">&quot;paintingArray.toGallery&quot;</SPAN>);
</PRE>
</DIV></DIV></LI>
	<LI>A query can have more than one prefetch path at the same time:
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
query.addPrefetch(<SPAN class="code-quote">&quot;paintingArray&quot;</SPAN>); 
query.addPrefetch(<SPAN class="code-quote">&quot;paintingArray.toGallery&quot;</SPAN>);
</PRE>
</DIV></DIV></LI>
	<LI><FONT color="red">PREFETCH LIMITATION:</FONT> To-many relationships should not be prefetched if a query qualifier can potentially reduce a number of related objects, resulting in incorrect relationship list. E.g.:
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
SelectQuery query = <SPAN class="code-keyword">new</SPAN> SelectQuery(Artist.class);

Expression exp = ExpressionFactory.matchExp(<SPAN class="code-quote">&quot;paintingArray.paintingTitle&quot;</SPAN>, <SPAN class="code-quote">&quot;Some Painting&quot;</SPAN>);

<SPAN class="code-comment">// INVALID!! since there can be more than one painting per artist, <SPAN class="code-keyword">this</SPAN> prefetch
</SPAN><SPAN class="code-comment">// wouldn't work.
</SPAN>query.addPrefetch(<SPAN class="code-quote">&quot;paintingArray&quot;</SPAN>); 
</PRE>
</DIV></DIV>
<P>In the future versions of Cayenne this will be addressed by using SQL subqueries. For now it is programmer's responsibility to avoid such prefetches.</P></LI>
	<LI>If SelectQuery is fetching data rows, all default prefetches are ignored, though custom joint prefetches (see below) will be included.</LI>
	<LI>When you customize SelectQuery prefetches to use joint semantics (see below how customization can be done), be aware that joint prefetch adds an extra inner join to the main query. This may result in fewer objects returned than expected. If you are SQL-savvy it may be helpful to think of disjoint prefetches as analogous to SQL outer joins and joint prefetches - to SQL inner joins.</LI>
</UL>


<P><EM>The rest of this page describes advanced use and can be skipped.</EM></P>


<H3><A name="Prefetching-PrefetchSemantics"></A>Prefetch Semantics</H3>

<P><EM>(semantics flavors were introduced in 1.2M3, with some changes in 1.2M8)</EM></P>

<P>Queries store prefetching information as trees of <TT>PrefetchTreeNode</TT> objects:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
PrefetchTreeNode treeRoot = query.getPrefetchTree();
<SPAN class="code-keyword">if</SPAN>(treeRoot != <SPAN class="code-keyword">null</SPAN>) {
  <SPAN class="code-comment">// <SPAN class="code-keyword">do</SPAN> something with tree nodes
</SPAN>}
</PRE>
</DIV></DIV>

<P>Each node specifies the name of prefetch path segment and execution semantics. There are two flavors of prefetch semantics - <B>joint</B> and <B>disjoint</B>. Semantics of each node is initially determined by Cayenne when a new prefetch path is added, and can be later customized by the user (e.g., see joint example below).</P>

<DIV class="panelMacro"><TABLE class="noteMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><img src="/docs/2.0/images/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD>In most cases prefetch semantics is of no concern to the users. Cayenne will do its best to configure the right semantics on the fly. Don't tweak semantics unless you understand the implications and have some proof that different semantics would result in better select performance on your database.</TD></TR></TABLE></DIV>

<P>Some internal semantics rules:</P>

<UL>
	<LI>SelectQuery uses disjoint prefetches by default.</LI>
	<LI>SQLTemplate and ProcedureQuery use joint prefetches and can not use disjoint semantics due to their nature.</LI>
	<LI>Prefetches with different semantics can be mixed freely within a query, as long as there is no conflict with other rules.</LI>
</UL>



<H3><A name="Prefetching-DisjointPrefetches"></A>Disjoint Prefetches</H3>

<P><EM>(available since 1.0)</EM></P>

<P>&quot;Disjoint&quot; prefetches (aka &quot;normal prefetches&quot;, as this is how Cayenne implemented prefetching since 1.0) internally result in a separate SQL statement per prefetch path.</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
SelectQuery query = <SPAN class="code-keyword">new</SPAN> SelectQuery(Artist.class);

<SPAN class="code-comment">// <SPAN class="code-quote">&quot;disjoint&quot;</SPAN> is <SPAN class="code-keyword">default</SPAN> semantics of SelectQuery
</SPAN>query.addPrefetch(<SPAN class="code-quote">&quot;paintingArray&quot;</SPAN>); 
query.addPrefetch(<SPAN class="code-quote">&quot;paintingArray.toGallery&quot;</SPAN>);

<SPAN class="code-comment">// <SPAN class="code-keyword">this</SPAN> will result in 1 main SQL query plus 2 extra prefetch queries
</SPAN>context.performQuery(query);
</PRE>
</DIV></DIV>

<H3><A name="Prefetching-JointPrefetches"></A>Joint Prefetches</H3>

<P><EM>(available since 1.2M3, with significant API changes in 1.2M8)</EM></P>

<P>&quot;Joint&quot; is prefetch type that issues a single SQL statement for multiple prefetch paths. Cayenne processes in memory a cartesian product of the entities involved, converting it to an object tree. SQLTemplate and ProcedureQuery create joint prefetches by default. SelectQuery needs to be told to use joint prefetch:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">
<SPAN class="code-comment">// after adding a <SPAN class="code-keyword">new</SPAN> prefetch, change its semantics to joint
</SPAN>query.addPrefetch(<SPAN class="code-quote">&quot;paintingArray&quot;</SPAN>).setSemantics(
                PrefetchTreeNode.JOINT_PREFETCH_SEMANTICS);

context.performQuery(query);
</PRE>
</DIV></DIV>

<P>Code above will result in a single SQL statement issued.</P>


                </section>
            </article>


<img referrerpolicy="no-referrer-when-downgrade" src="https://static.scarf.sh/a.png?x-pxid=5c836e39-be6b-4a21-a946-a97b5b69f172" />
	        </div>
	    </div>
	</div>
</main>

<footer class="bg-dark">
    <div class="footer-nav container  text-center text-lg-left  pb-3">
        <div class="row  pt-5 pb-3">
            
            <div class="col-sm-6 col-lg-3">
                <h4>About</h4>
                <ul class="list-unstyled">
                    
                    <li>
                        <a href="/why-cayenne.html">Why Cayenne?</a>
                    </li>
                    
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    
                    <li>
                        <a href="/success-stories.html">Success Stories</a>
                    </li>
                    
                    <li>
                        <a href="/about/support/">Support</a>
                    </li>
                    
                </ul>
            </div>
            
            <div class="col-sm-6 col-lg-3">
                <h4>Documentation</h4>
                <ul class="list-unstyled">
                    
                    <li>
                        <a href="/docs/4.0/getting-started-guide/">Getting Started (4.0)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.1/getting-started-guide/">Getting Started (4.1)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.2/getting-started-guide/">Getting Started (4.2)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.0/cayenne-guide/">Cayenne Guide (4.0)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.1/cayenne-guide/">Cayenne Guide (4.1)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.2/cayenne-guide/">Cayenne Guide (4.2)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.1/getting-started-db-first/">Database First tutorial (4.1)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.2/getting-started-db-first/">Database First tutorial (4.2)</a>
                    </li>
                    
                </ul>
            </div>
            
            <div class="col-sm-6 col-lg-3">
                <h4>Collaboration</h4>
                <ul class="list-unstyled">
                    
                    <li>
                        <a href="https://issues.apache.org/jira/browse/CAY">Bug/Feature Tracker</a>
                    </li>
                    
                    <li>
                        <a href="/mailing-lists.html">Mailing Lists</a>
                    </li>
                    
                    <li>
                        <a href="/dev/code-repository.html">Code Repository</a>
                    </li>
                    
                    <li>
                        <a href="/dev/">Developer Guide</a>
                    </li>
                    
                    <li>
                        <a href="/how-can-i-help.html">How can I help?</a>
                    </li>
                    
                    <li>
                        <a href="/contributors.html">Contributors</a>
                    </li>
                    
                    <li>
                        <a href="/thanks.html">Thanks</a>
                    </li>
                    
                </ul>
            </div>
            
            <div class="col-sm-6 col-lg-3">
                <h4>News</h4>
                <ul class="list-multiline-items list-unstyled  mb-0">
                    
                    <li>
                        <time datetime="2023-05-25 18:00:00 &#43;0300 &#43;0300" class="xsmall d-block">May 25, 2023</time>
                        <a href="/2023/05/cayenne-42-final-released/">Cayenne 4.2 Final Released</a>
                    </li>
                    
                    <li>
                        <time datetime="2023-03-02 12:00:00 &#43;0300 &#43;0300" class="xsmall d-block">Mar 02, 2023</time>
                        <a href="/2023/03/cayenne-403-released/">Cayenne 4.0.3 Released</a>
                    </li>
                    
                    <li>
                        <time datetime="2022-12-05 12:00:00 &#43;0300 &#43;0300" class="xsmall d-block">Dec 05, 2022</time>
                        <a href="/2022/12/cayenne-42rc2-released/">Cayenne 4.2 Release Candidate 2 Released</a>
                    </li>
                    
                </ul>
                <a class="btn-link text-uppercase xsmall" href="https://cayenne.apache.org/news">
                    More news
                    <i class="fa fa-lg fa-long-arrow-right" aria-hidden="true"></i>
                </a>
            </div>
        </div>
        <hr class="mt-0 mb-3" />
        <p class="copy xsmall text-center  mw-75 mx-auto mb-0">
            Copyright © 2001-2024 Apache Software Foundation. Apache Cayenne, Cayenne, Apache, the Apache feather logo, and the Apache Cayenne project logo are trademarks of The Apache Software Foundation.
            <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy policy</a>.
            <img class="d-block  mx-auto mt-2" src="/img/logo_mono-3302daa3cf.svg" alt="Apache Cayenne" />
        </p>
    </div>
</footer>
    
    </body>
</html>
