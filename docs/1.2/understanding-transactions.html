<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.3">
        <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon-04cb17e028.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32-12431ee8eb.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16-4f316e4d55.png">
        <link rel="manifest" href="/img/favicon/manifest-65e6aaa49e.json">
        <link rel="mask-icon" href="/img/favicon/safari-pinned-tab-558c1991b1.svg" color="#dc5656">
        <link rel="shortcut icon" href="/img/favicon/favicon-6cef91375b.ico">
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="/img/favicon/mstile-144x144-34e7696278.png">
        <meta name="msapplication-config" content="/img/favicon/browserconfig-82ff158058.xml">
        <meta name="theme-color" content="#ffffff">
        <link rel="stylesheet" href="https://cayenne.apache.org/css/styles-a216e88c4f.css"/>
        <script src="https://cayenne.apache.org/js/bundle-b017b6b604.js"></script>
        <title>Understanding Transactions &middot; Apache Cayenne</title>
    </head>
    <body data-spy="scroll" data-target=".toc-side" class="cd-head"> 
<header class="page-header">
    <nav id="topbar" class="bg-dark" aria-label="breadcrumb" role="navigation">
      <ul class="breadcrumb breadcrumb-sm breadcrumb-dark  container  mb-0">
        <li class="breadcrumb-item dropdown">
          <a class="dropdown-toggle  text-nowrap  pr-1" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <img class="mw-15px  mr-1" src="/img/feather-641aa69d09.svg" />Apache Software Foundation</a>
          <div class="dropdown-menu rounded-0" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="https://www.apache.org">Apache Homepage</a>
            <a class="dropdown-item" href="https://www.apache.org/licenses/">License</a>
            <a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
            <a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a>
            <a class="dropdown-item" href="https://www.apache.org/security/">Security</a>
            <a class="dropdown-item" href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy</a>
            <a class="ml-1 mt-1 acevent" data-format="wide" data-mode="dark" data-width="120"></a>
          </div>
        </li>
      </ul>
    </nav>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="https://cayenne.apache.org/">
           <img src="/img/logo_mono_full-d7a19eef61.svg" alt="Apache Cayenne" />
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#mainMenu" aria-controls="mainMenu" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainMenu">
          <ul class="navbar-nav  mt-3 mt-lg-0 mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="/download/">DOWNLOAD</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="/docs/4.2/getting-started-guide/">DOCUMENTATION</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="/about/support/">SUPPORT</a>
            </li>
            
          </ul>
          <ul class="navbar-nav  flex-row justify-content-center  mt-2 mt-lg-0 mb-2 mb-lg-0 " id="social-links-menu">
            <li class="nav-item  d-flex">
              <a class="nav-link  d-flex justify-content-center align-items-center" href="https://github.com/apache/cayenne">
                <img src="/img/icon_octocat_stars-c24dac94b8.svg" alt="GitHub" />
              </a>
            </li>
            <li class="nav-item  d-flex">
              <a class="nav-link  d-flex justify-content-center align-items-center" href="https://twitter.com/ApacheCayenne">
                <img src="/img/icon_twitter-220a129d14.svg" alt="Twitter" />
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
</header>








<main>
    <div class="cd-top-sidebar  bb">
        <div class="container">
            <div class="row no-gutters">
                
                <div class="col-12 col-lg-4 col-xl-3  br  cd-sidebar1">
                    <ul class="nav" role="tablist">
                        <li class="nav-item dropdown mw-100">
                            <a class="nav-link dropdown-toggle text-truncate" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                                Cayenne Version 1.2
                            </a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="/docs/4.2/getting-started-guide/">Version 4.2 (Stable)</a><a class="dropdown-item" href="/docs/4.1/getting-started-guide/">Version 4.1 (Stable)</a><a class="dropdown-item" href="/docs/4.0/getting-started-guide/">Version 4.0 (Aging)</a><a class="dropdown-item" href="/docs/3.1/getting-started-guide/">Version 3.1 (Legacy)</a><a class="dropdown-item" href="/docs/3.0/cayenne-guide.html">Version 3.0 (Legacy)</a><a class="dropdown-item" href="/docs/2.0/user-guide.html">Version 2.0 (Legacy)</a><a class="dropdown-item" href="/docs/1.2/user-guide.html">Version 1.2 (Legacy)</a>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="col-12 col-lg-8 col-xl-9">  </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row no-gutters  ">
            <div class="col-12 col-lg-4 col-xl-3  br  py-2  bg-gray-100  cd-sidebar">
                <div class="tab-content" id="cd-docs-nav">
                    
                    <div class="cd-toc-item">
                        
                            <a class="cd-toc-link" href="/docs/1.2/user-guide.html">User Guide</a>
                        
                    </div>
                    
                    <div class="cd-toc-item">
                        
                            <a class="cd-toc-link" href="/docs/1.2/modeler-guide.html">Modeler Guide</a>
                        
                    </div>
                    
                    <div class="cd-toc-item">
                        
                            <a class="cd-toc-link" href="/docs/1.2/remote-object-persistence-guide.html">Remote Object Persistence Guide</a>
                        
                    </div>
                    
                    <div class="cd-toc-item">
                        <a class="cd-toc-link" href="/docs/1.2/api/">JavaDoc</a>
                    </div>
                </div>
            </div>
            
            <div class="col-12 col-lg-8 col-xl-9  py-3 pl-lg-5  cd-content">

            
            <article>
                <section>
                    
	

<P>Cayenne has its own simple transaction API centered around <TT>org.objectstyle.cayenne.access.Transaction</TT> class. Its goal is to ensure consistency of the DataContext database operations. It works either as a standalone mechanism, or in conjunction with another transaction framework, such as JTA or Spring. To switch between the two modes of operation, use &quot;Container-Managed Transactions&quot; checkbox in the DataDomain editing panel in CayenneModeler:</P>

<P><SPAN class="image-wrap" style=""><img src="/docs/1.2/images/transactions-types.jpg" style="border: 0px solid black"></SPAN></P>

<P>If this box is unchecked (default), standalone mode is used and Cayenne will take care of transactional resources management on its own. If it is checked, Cayenne won't commit or rollback transactional resources, relying on the external transaction manager to do that.</P>

<P>In both cases Transaction API works implicitly behind the scenes, so the application doesn't need to interact with it directly. In that Cayenne Transactions are fully declarative.</P>

<H3><A name="UnderstandingTransactions-HowTransactionsWork"></A>How Transactions Work</H3>

<P>Similar to the Java EE approach, Cayenne transactions are bound to the current thread for the duration of the execution. For instance this is how Cayenne does an internal check of whether there is a transaction in progress:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"><SPAN class="code-keyword">import</SPAN> org.objectstyle.cayenne.access.Transaction;
...
Transaction currentTx = Transaction.getThreadTransaction();
<SPAN class="code-keyword">if</SPAN>(currentTx != <SPAN class="code-keyword">null</SPAN>) {
  <SPAN class="code-comment">// transaction in process...
</SPAN>}
</PRE>
</DIV></DIV>

<P>When a Transaction is created inside Cayenne, it is immediately bound to the thread:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">Transaction tx = ...;
Transaction.bindThreadTransaction(tx);</PRE>
</DIV></DIV>

<P>Now let's revisit the flow of a typical operation that requires a transaction:</P>
<OL>
	<LI>A DataContext sends a query or a commit request to the underlying <TT>org.objectstyle.cayenne.DataChannel</TT>.</LI>
	<LI>The request travels the chain of DataChannels until it reaches one that is a <TT>org.objectstyle.cayenne.access.DataDomain</TT>.</LI>
	<LI>DataDomain analyzes context request and dispatches data queries to one or more <TT>org.objectstyle.cayenne.access.DataNodes</TT>.</LI>
	<LI>Each DataNode opens a JDBC Connection and executes queries.</LI>
</OL>


<P>Transactions come into play in <B>step 3</B>. DataDomain checks whether there is an existing Transaction in process and if not - creates and starts a new one (standalone or container, depending on the preconfigured type). In that Cayenne transaction policy is similar to Java EE <TT>&quot;REQUIRE&quot;</TT> policy.</P>

<P>Later in <B>step 4</B> DataNodes will attach any of the Connections they obtains to the ongoing transaction:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"><SPAN class="code-keyword">import</SPAN> java.sql.Connection;
...
Connection connection = ...
currentTx.addConnection(<SPAN class="code-quote">&quot;someKey&quot;</SPAN>, connection);</PRE>
</DIV></DIV>

<H3><A name="UnderstandingTransactions-TransactionLifecycleCallbacks%3ATransactionDelegate"></A>Transaction Lifecycle Callbacks: TransactionDelegate</H3>

<P>If you want to execute some custom code, such as Cayenne queries or raw JDBC queries at certain points in transaction lifecycle, you need to implement a <TT>org.objectstyle.cayenne.access.TransactionDelegate</TT> callback interface:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">ublic class MyTxCallback <SPAN class="code-keyword">implements</SPAN> TransactionDelegate {

    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> willCommit(Transaction transaction) {
        <SPAN class="code-comment">// run extra query before transaction is committed
</SPAN>
        <SPAN class="code-comment">// The results of it will be committed or rolled back together with the current Transaction. 
</SPAN>
        DataContext context = DataContext.getThreadDataContext();
        context.performGenericQuery(<SPAN class="code-keyword">new</SPAN> SQLTemplate(X.class, <SPAN class="code-quote">&quot;...&quot;</SPAN>));

        <SPAN class="code-comment">// <SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">true</SPAN>, letting Cayenne know it should <SPAN class="code-keyword">continue</SPAN> with commit
</SPAN>        <SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">true</SPAN>;
    }

    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> willMarkAsRollbackOnly(Transaction transaction) {
        <SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">true</SPAN>;
    }

    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> willRollback(Transaction transaction) {
        <SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">true</SPAN>;
    }

    <SPAN class="code-keyword">public</SPAN> void didCommit(Transaction transaction) {
    }

    <SPAN class="code-keyword">public</SPAN> void didRollback(Transaction transaction) {
    }

    <SPAN class="code-keyword">public</SPAN> <SPAN class="code-object">boolean</SPAN> willAddConnection(Transaction transaction, Connection connection) {
        <SPAN class="code-keyword">return</SPAN> <SPAN class="code-keyword">true</SPAN>;
    }
}
</PRE>
</DIV></DIV>

<P>Then an instance can be registered with the DataDomain. </P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">DataDomain domain = Configuration.getSharedConfiguration().getDomain();
domain.setTransactionDelegate(<SPAN class="code-keyword">new</SPAN> MyTxCallback());
</PRE>
</DIV></DIV>

<P>The delegate is shared by all DataContexts.</P>

<H3><A name="UnderstandingTransactions-UserDefinedTransactionScope"></A>User-Defined Transaction Scope</H3>

<P>If the application needs to define its own transactional scope (e.g. wrap more than one <TT>DataContext.commitChanges()</TT> in a single database transaction), an explict <TT>org.objectstyle.cayenne.access.Transaction</TT> can be started. It will serve as a simple substitute for the JTA transactions (of course JTA UserTransaction can be used instead if desired).</P>

<DIV class="panelMacro"><TABLE class="noteMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><img src="/docs/1.2/images/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD>If the user code starts a Transaction, it <B>must</B> explicitly invoke &quot;commit/rollback&quot; methods and unbind the Transaction from the current thread when it is finished. Failure to do that may result in connection leaks. Of course if Cayenne starts an implicit transaction, it does the cleanup internally on its own.</TD></TR></TABLE></DIV>

<P>Below is an example of user-controlled Transaction code. First it obtains a new transaction from the DataDomain (alternatively users can create Transaction subclasses of their own):</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">DataDomain domain = Configuration.getSharedConfiguration().getDomain();
Transaction tx = domain.createTransaction();
</PRE>
</DIV></DIV>

<P>As we must finish transaction regardless of the outcome, wrap the rest of the code in try/catch/finally. Don't foget to bind/unbind the transaction, so that Cayenne stack is aware of it:</P>

<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">Transaction.bindThreadTransaction(tx);

<SPAN class="code-keyword">try</SPAN> {
    <SPAN class="code-comment">// <SPAN class="code-keyword">do</SPAN> something...
</SPAN>    ....
    <SPAN class="code-comment">// <SPAN class="code-keyword">if</SPAN> no failures, commit
</SPAN>    tx.commit();
}
<SPAN class="code-keyword">catch</SPAN> (Exception ex) {
    tx.setRollbackOnly();
}
<SPAN class="code-keyword">finally</SPAN> {
    Transaction.bindThreadTransaction(<SPAN class="code-keyword">null</SPAN>);
 
    <SPAN class="code-keyword">if</SPAN> (tx.getStatus() == Transaction.STATUS_MARKED_ROLLEDBACK) {
        <SPAN class="code-keyword">try</SPAN> {
           tx.rollback();
        }
        <SPAN class="code-keyword">catch</SPAN> (Exception rollbackEx) {
        }
    }
}
</PRE>
</DIV></DIV>

                </section>
            </article>


<img referrerpolicy="no-referrer-when-downgrade" src="https://static.scarf.sh/a.png?x-pxid=5c836e39-be6b-4a21-a946-a97b5b69f172" />
	        </div>
	    </div>
	</div>
</main>

<footer class="bg-dark">
    <div class="footer-nav container  text-center text-lg-left  pb-3">
        <div class="row  pt-5 pb-3">
            
            <div class="col-sm-6 col-lg-3">
                <h4>About</h4>
                <ul class="list-unstyled">
                    
                    <li>
                        <a href="/why-cayenne.html">Why Cayenne?</a>
                    </li>
                    
                    <li>
                        <a href="/download/">Download</a>
                    </li>
                    
                    <li>
                        <a href="/success-stories.html">Success Stories</a>
                    </li>
                    
                    <li>
                        <a href="/about/support/">Support</a>
                    </li>
                    
                </ul>
            </div>
            
            <div class="col-sm-6 col-lg-3">
                <h4>Documentation</h4>
                <ul class="list-unstyled">
                    
                    <li>
                        <a href="/docs/4.0/getting-started-guide/">Getting Started (4.0)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.1/getting-started-guide/">Getting Started (4.1)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.2/getting-started-guide/">Getting Started (4.2)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.0/cayenne-guide/">Cayenne Guide (4.0)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.1/cayenne-guide/">Cayenne Guide (4.1)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.2/cayenne-guide/">Cayenne Guide (4.2)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.1/getting-started-db-first/">Database First tutorial (4.1)</a>
                    </li>
                    
                    <li>
                        <a href="/docs/4.2/getting-started-db-first/">Database First tutorial (4.2)</a>
                    </li>
                    
                </ul>
            </div>
            
            <div class="col-sm-6 col-lg-3">
                <h4>Collaboration</h4>
                <ul class="list-unstyled">
                    
                    <li>
                        <a href="https://issues.apache.org/jira/browse/CAY">Bug/Feature Tracker</a>
                    </li>
                    
                    <li>
                        <a href="/mailing-lists.html">Mailing Lists</a>
                    </li>
                    
                    <li>
                        <a href="/dev/code-repository.html">Code Repository</a>
                    </li>
                    
                    <li>
                        <a href="/dev/">Developer Guide</a>
                    </li>
                    
                    <li>
                        <a href="/how-can-i-help.html">How can I help?</a>
                    </li>
                    
                    <li>
                        <a href="/contributors.html">Contributors</a>
                    </li>
                    
                    <li>
                        <a href="/thanks.html">Thanks</a>
                    </li>
                    
                </ul>
            </div>
            
            <div class="col-sm-6 col-lg-3">
                <h4>News</h4>
                <ul class="list-multiline-items list-unstyled  mb-0">
                    
                    <li>
                        <time datetime="2023-05-25 18:00:00 &#43;0300 &#43;0300" class="xsmall d-block">May 25, 2023</time>
                        <a href="/2023/05/cayenne-42-final-released/">Cayenne 4.2 Final Released</a>
                    </li>
                    
                    <li>
                        <time datetime="2023-03-02 12:00:00 &#43;0300 &#43;0300" class="xsmall d-block">Mar 02, 2023</time>
                        <a href="/2023/03/cayenne-403-released/">Cayenne 4.0.3 Released</a>
                    </li>
                    
                    <li>
                        <time datetime="2022-12-05 12:00:00 &#43;0300 &#43;0300" class="xsmall d-block">Dec 05, 2022</time>
                        <a href="/2022/12/cayenne-42rc2-released/">Cayenne 4.2 Release Candidate 2 Released</a>
                    </li>
                    
                </ul>
                <a class="btn-link text-uppercase xsmall" href="https://cayenne.apache.org/news">
                    More news
                    <i class="fa fa-lg fa-long-arrow-right" aria-hidden="true"></i>
                </a>
            </div>
        </div>
        <hr class="mt-0 mb-3" />
        <p class="copy xsmall text-center  mw-75 mx-auto mb-0">
            Copyright © 2001-2024 Apache Software Foundation. Apache Cayenne, Cayenne, Apache, the Apache feather logo, and the Apache Cayenne project logo are trademarks of The Apache Software Foundation.
            <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy policy</a>.
            <img class="d-block  mx-auto mt-2" src="/img/logo_mono-3302daa3cf.svg" alt="Apache Cayenne" />
        </p>
    </div>
</footer>
    
    </body>
</html>
